# Sensor

The sensor is the part of vjoule retreiving `perf_events`. It
divides the `perf_events` in to subgroups, system and cgroups. The
sensor works with cgroup v2. An adaptation for cgroup v1 should be
relatively easy.

## Installation

The sensor uses the patched version of the libpfm. This
patched version can be found in the directory `patch_libpfm`, and is
compiled and linked automatically using the cmake files.

```bash
./deb/create-deb.sh
sudo dpkg -i ./build/vjoule_1.0.deb
```

The sensor binary is installed in
`/usr/bin/vjoule_sensor`. Configuration files are put in
`/etc/vjoule/`. A service file is put in `/etc/systemd/system/vjoule_sensor.service`

## Uninstallation 

```bash
sudo dpkg -r vjoule-1.0
```

## Usage

The sensor is a service, that is started using the command : 

```
sudo systemctl start vjoule_sensor.service
```

And stopped : 

```
sudo systemctl stop vjoule_sensor.service
```

## Configuration 

The configuration of the sensor is made using a `toml` file. An
example of this file is presented below. The configuration file has to
be located in `/etc/vjoule/sensor/config.toml`. Basically, every file
read or generated by the sensor are located in the directory
`/etc/vjoule/`. Configuration file must be present but every
parameters are optional and have a default value.

```toml
[sensor]
addr = "0.0.0.0:0"
freq = 1.0
log-lvl = "info"
log-path = "/etc/vjoule/sensor.log"

[cgroups]
slices = ["custom.slice"]

[events]
system = ["RAPL_ENERGY_PKG", "TSC", "APERF", "MPERF"]

cgroups = ["CPU_CLK_THREAD_UNHALTED:REF_P",
	       "CPU_CLK_THREAD_UNHALTED:THREAD_P",
           "LLC_MISSES",
           "INSTRUCTIONS_RETIRED"]
```

- `sensor` defines information about the sensor deamon. 
  - `addr` is the address on which the sensor is listening for
	formulas to connect. By setting its port value to `0`, it will get
	the first port that is available. The used port is defined in
	`/etc/vjoule/port`. Default value is `0.0.0.0:0`.

  - `freq` defines the frequency in Hz of the sensor (number of report sent by seconds to the formulas). Default value is `1.0`
  
  - `log-lvl` defines the level of the logger, default value is `success`, possible values `none < error < warn < info < success < strange < all`.
  - `log-path` defines the path of the log file, default is empty which means to stdout.
  - `max-open-files` defines the number of file descriptor the process can open, default is 65535. This is a linux limit, when there many cgroup to observe we need to open more than 1024 files (default linux limit).
  - `poll-freq` applicable only in nfs mode (sensor inside virtual machines). Defines the speed of the polling, to discover the new reports from the host formula. (nfs does not implement inotify, so we need to poll to check for modifications).
- `cgroups` defines information about the cgroup watched by the sensor.
  - `slices` defines the list of slices watched by the sensor. Other slices are ignored.
  For example, by defining `slices=["custom.slice"]`, all sub cgroups inside `custom.slice` (`custom.slice/my-cgroup`, `custom/my-second-cgroup`) are watched, but not directly `custom.slice`. It is also not recursive, so `custom.slice/sub.slice/test` is watched through `custom/sub.slice` but not directly. 
  
- `events` defines the list of event being watched by the sensor
  - `system` the list of system event being watched
  - `cgroups` the list of events being watched for every cgroup being watched by the sensor
  

