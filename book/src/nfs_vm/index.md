# NFS

The nfs_vm service provides the ability to mount result files to
running VMs. It uses libvirt to discover running VMs, and is attached
to a given formula. When a VM is created the nfs service add an entry
to the nfs `/etc/exports` file to give the possibility to the VM to
mount its energy result folder.

## Installation 

The nfs_vm is created in the same deb package as the sensor or other formulas.

```bash
./deb/create-deb.sh
sudo dpkg -i ./build/vjoule_1.0_full.deb
```

The nfs_vm binary is installed in
`/usr/bin/vjoule_nfs_vm`. Configuration files are put in
`/etc/vjoule/nfs_vm/`. A service file is put in
`/etc/systemd/system/vjoule_nfs_vm.service`.

## Unistallation 

```
sudo dpkg -r vjoule-1.0_full
```

## Usage 

The nfs_vm is a service. The formula attached to the nfs\_vm service must be running (see configuration)

```bash
sudo systemctl start vjoule_nfs_vm.service
```

And stopped :

```bash
sudo systemctl stop vjoule_nfs_vm.service
```


## Configuration

The configuration of the nfs_vm is made with a toml file. An example
of this file is presented below. The configuration file has to be
located in `/etc/vjoule/nfs_vm/config.toml`. Basically,
every file read or generated by the nfs_vm are located in the
directory `/etc/vjoule/`. Configuration file must be present but
every parameters are optional and have a default value.

```toml
[nfs_vm]
formula-dir = "/etc/vjoule/simple_formula/"
log-path = "/etc/vjoule/nfs_vm.log"
log-lvl = "info"
qemu-uri = "qemu:///system"
```

- `nfs_vm` defines information about the nfs pusher
  - `log-path` defines the path of the log file, default is empty which means to stdout
  - `log-lvl` defines the level of the logger, default value is
    success, possible values `none < error < warn < info < success < strange < all`
  - `formula-dir` defines the directory in which the formula writes
    its results. This is where the nfs_vm will find the cgroups of the
    VMs, assuming that all cgroups in the `machine.slice` slice are
    VMs.
  - `qemu-uri` defines the uri of the qemu system running on the host machine (to retreive VM information)

To run properly, the nfs_vm needs a sensor configured to watch the slice `machine.slice`.

## Limitations

The nfs_vm is the simplest way of providing the results to the running VMs. However it suffers some limitations : 
- inotify does not work on nfs, meaning that the only way of reading
  the result is by polling (loop until the modification date of the
  result file changed). This is cpu consuming and is not really a good
  idea for our solution, tcp_vm is running a tcp server that vm sensor
  can connect and seems to be a better way of sending datas to vms.
  
