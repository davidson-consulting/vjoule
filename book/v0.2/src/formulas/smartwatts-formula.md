# Smartwatts formula

This formula is an implementation of the paper *SmartWatts: Self-Calibrating Software-Defined Power Meter for Containers* by Fieni et al., based on the [original python implementation](https://github.com/vjoule-ng/smartwatts-formula).

## Concepts

This formula dispatch the energy consumption of the host (gathered by the sensor) based on performances events. Smartwatts uses 
a linear regression model to infer the power consumption of each monitored cgroup.



## Installation 

The formula is created in the same deb package as the sensor or other formulas.

```bash
./deb/create-deb.sh
sudo dpkg -i ./build/vjoule_1.0_no_nfs.deb
```

The formula binary is installed in
`/usr/bin/vjoule_smartwatts_formula`. Configuration files are put in
`/etc/vjoule/smartwatts_formula/`. A service file is put in
`/etc/systemd/system/vjoule_smartwatts_formula.service`.

## Unistallation 

```
sudo dpkg -r vjoule-1.0-no-nfs
```

## Usage 

The smartwatts formula is a service. It depends on the `vjoule_sensor.service`. 

```bash
sudo systemctl start vjoule_smartwatts_formula.service
```

And stopped :

```bash
sudo systemctl stop vjoule_smartwatts_formula.service
```

## Configuration

The configuration of the formula is made with a toml file. An example
of this file is presented below. The configuration file has to be
located in `/etc/vjoule/smartwatts_formula/config.toml`. Basically,
every file read or generated by the formula are located in the
directory `/etc/vjoule/`. Configuration file must be present but
every parameters are optional and have a default value.

```toml
[formula]
log-path = "/etc/vjoule/formula.log"
log-lvl = "info"
mnt-path = "/etc/vjoule/smartwatts-formula/"
reconf-sensor = true
```

- `formula` defines information about the formula
  - `log-path` defines the path of the log file, default is empty which means to stdout.
  - `log-lvl` defines the level of the logger, default value is success, possible values none < error < warn < info < success < strange < all
  - `mnt-path` defines the directory that will receive the result of the formula
  - `reconf-sensor`, if true the formula modifies the configuration file of the sensor to make sure it is monitoring the correct metrics. Can be enforced to false, when running two different formulas (for comparison for example).
