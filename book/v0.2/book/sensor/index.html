<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Sensor - vJoule doc</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Documentation for vJoule.">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        
        <link rel="stylesheet" href="custom.css">
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="./home/index.html"><strong>1.</strong> Home</a></li><li><a href="./getting_started/index.html"><strong>2.</strong> Getting started</a></li><li><ul class="section"><li><a href="./getting_started/what_is_vjoule.html"><strong>2.1.</strong> What is vJoule?</a></li><li><a href="./getting_started/installation.html"><strong>2.2.</strong> Installation</a></li><li><a href="./getting_started/first_tests.html"><strong>2.3.</strong> First tests</a></li></ul></li><li><a href="./user_guide/index.html"><strong>3.</strong> User Guide</a></li><li><ul class="section"><li><a href="./user_guide/cgroups.html"><strong>3.1.</strong> cgroups</a></li><li><a href="./user_guide/directories_layout.html"><strong>3.2.</strong> Config files, logs and results</a></li><li><a href="./user_guide/pullers.html"><strong>3.3.</strong> Fetching results with pullers</a></li><li><a href="./user_guide/dumping_formula.html"><strong>3.4.</strong> The dumping formula</a></li></ul></li><li><a href="./tutorial/index.html"><strong>4.</strong> Tutorials</a></li><li><ul class="section"><li><a href="./tutorial/mesuring.html"><strong>4.1.</strong> Evaluate a script</a></li><li><a href="./tutorial/fetch_results.html"><strong>4.2.</strong> Fetching results in a program</a></li></ul></li><li><a href="./api_reference/index.html"><strong>5.</strong> API Reference</a></li><li><ul class="section"><li><a href="./sensor/index.html" class="active"><strong>5.1.</strong> Sensor</a></li><li><ul class="section"><li><a href="./sensor/protocol.html"><strong>5.1.1.</strong> protocol</a></li><li><a href="./sensor/impl.html"><strong>5.1.2.</strong> c++ implementation</a></li><li><ul class="section"><li><a href="./sensor/impl-sensor.html"><strong>5.1.2.1.</strong> class sensor::Sensor</a></li><li><a href="./sensor/impl-notif.html"><strong>5.1.2.2.</strong> class sensor::Notifier</a></li><li><a href="./sensor/impl-perf-event.html"><strong>5.1.2.3.</strong> class sensor::perf::PerfEventWatcher</a></li><li><a href="./sensor/impl-cgroup-lister.html"><strong>5.1.2.4.</strong> class sensor::cgroup::CgroupLister</a></li></ul></li></ul></li><li><a href="./formulas/index.html"><strong>5.2.</strong> Formula</a></li><li><ul class="section"><li><a href="./formulas/simple-formula.html"><strong>5.2.1.</strong> Simple formula</a></li><li><a href="./formulas/smartwatts-formula.html"><strong>5.2.2.</strong> Smartwatts formula</a></li><li><a href="./formulas/implementing-new-formula.html"><strong>5.2.3.</strong> Implementing a new formula</a></li></ul></li><li><a href="./pullers/index.html"><strong>5.3.</strong> Pullers</a></li></ul></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">vJoule doc</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="./sensor/index.html#sensor" id="sensor"><h1>Sensor</h1></a>
<p>The sensor is the part of vjoule retreiving <code>perf_events</code>. It
divides the <code>perf_events</code> in to subgroups, system and cgroups. The
sensor works with cgroup v2. An adaptation for cgroup v1 should be
relatively easy.</p>
<a class="header" href="./sensor/index.html#installation" id="installation"><h2>Installation</h2></a>
<p>The sensor uses the patched version of the libpfm. This
patched version can be found in the directory <code>patch_libpfm</code>, and is
compiled and linked automatically using the cmake files.</p>
<pre><code class="language-bash">./deb/create-deb.sh
sudo dpkg -i ./build/vjoule_1.0.deb
</code></pre>
<p>The sensor binary is installed in
<code>/usr/bin/vjoule_sensor</code>. Configuration files are put in
<code>/etc/vjoule/</code>. A service file is put in <code>/etc/systemd/system/vjoule_sensor.service</code></p>
<a class="header" href="./sensor/index.html#uninstallation" id="uninstallation"><h2>Uninstallation</h2></a>
<pre><code class="language-bash">sudo dpkg -r vjoule-1.0
</code></pre>
<a class="header" href="./sensor/index.html#usage" id="usage"><h2>Usage</h2></a>
<p>The sensor is a service, that is started using the command :</p>
<pre><code>sudo systemctl start vjoule_sensor.service
</code></pre>
<p>And stopped :</p>
<pre><code>sudo systemctl stop vjoule_sensor.service
</code></pre>
<a class="header" href="./sensor/index.html#configuration" id="configuration"><h2>Configuration</h2></a>
<p>The configuration of the sensor is made using a <code>toml</code> file. An
example of this file is presented below. The configuration file has to
be located in <code>/etc/vjoule/sensor/config.toml</code>. Basically, every file
read or generated by the sensor are located in the directory
<code>/etc/vjoule/</code>. Configuration file must be present but every
parameters are optional and have a default value.</p>
<pre><code class="language-toml">[sensor]
addr = &quot;0.0.0.0:0&quot;
freq = 1.0
log-lvl = &quot;info&quot;
log-path = &quot;/etc/vjoule/sensor.log&quot;

[cgroups]
slices = [&quot;custom.slice&quot;]

[events]
system = [&quot;RAPL_ENERGY_PKG&quot;, &quot;TSC&quot;, &quot;APERF&quot;, &quot;MPERF&quot;]

cgroups = [&quot;CPU_CLK_THREAD_UNHALTED:REF_P&quot;,
           &quot;CPU_CLK_THREAD_UNHALTED:THREAD_P&quot;,
           &quot;LLC_MISSES&quot;,
           &quot;INSTRUCTIONS_RETIRED&quot;]
</code></pre>
<ul>
<li>
<p><code>sensor</code> defines information about the sensor deamon.</p>
<ul>
<li>
<p><code>addr</code> is the address on which the sensor is listening for
formulas to connect. By setting its port value to <code>0</code>, it will get
the first port that is available. The used port is defined in
<code>/etc/vjoule/port</code>. Default value is <code>0.0.0.0:0</code>.</p>
</li>
<li>
<p><code>freq</code> defines the frequency in Hz of the sensor (number of report sent by seconds to the formulas). Default value is <code>1.0</code></p>
</li>
<li>
<p><code>log-lvl</code> defines the level of the logger, default value is <code>success</code>, possible values <code>none &lt; error &lt; warn &lt; info &lt; success &lt; strange &lt; all</code>.</p>
</li>
<li>
<p><code>log-path</code> defines the path of the log file, default is empty which means to stdout.</p>
</li>
<li>
<p><code>max-open-files</code> defines the number of file descriptor the process can open, default is 65535. This is a linux limit, when there many cgroup to observe we need to open more than 1024 files (default linux limit).</p>
</li>
<li>
<p><code>poll-freq</code> applicable only in nfs mode (sensor inside virtual machines). Defines the speed of the polling, to discover the new reports from the host formula. (nfs does not implement inotify, so we need to poll to check for modifications).</p>
</li>
</ul>
</li>
<li>
<p><code>cgroups</code> defines information about the cgroup watched by the sensor.</p>
<ul>
<li><code>slices</code> defines the list of slices watched by the sensor. Other slices are ignored.
For example, by defining <code>slices=[&quot;custom.slice&quot;]</code>, all sub cgroups inside <code>custom.slice</code> (<code>custom.slice/my-cgroup</code>, <code>custom/my-second-cgroup</code>) are watched, but not directly <code>custom.slice</code>. It is also not recursive, so <code>custom.slice/sub.slice/test</code> is watched through <code>custom/sub.slice</code> but not directly.</li>
</ul>
</li>
<li>
<p><code>events</code> defines the list of event being watched by the sensor</p>
<ul>
<li><code>system</code> the list of system event being watched</li>
<li><code>cgroups</code> the list of events being watched for every cgroup being watched by the sensor</li>
</ul>
</li>
</ul>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="./api_reference/index.html" class="mobile-nav-chapters previous" title="Previous chapter">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="./sensor/protocol.html" class="mobile-nav-chapters next" title="Next chapter">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./api_reference/index.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./sensor/protocol.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        
    <script type="text/javascript">
        var socket = new WebSocket("ws://localhost:3001");
        socket.onmessage = function (event) {
            if (event.data === "reload") {
                socket.close();
                location.reload(true); // force reload from server (not from cache)
            }
        };

        window.onbeforeunload = function() {
            socket.close();
        }
    </script>


        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        
        <script type="text/javascript" src="custom.js"></script>
        

    </body>
</html>
